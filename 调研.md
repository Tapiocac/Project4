# 了解

## 什么是Fast DDS

基于DDS规范的C++实现，以数据为中心的发布者-订阅者模型

## 关键特性

- 使用类型化的接口
- 基于多对多的分布式网络范式
  - 实现通信的发布者与订阅者的分离

信息流由负责数据交换的实体之间建立的服务质量（QoS）策略进行调节

数据是在"全局数据空间"中广播的，**发布者**将新数据发布到这个空间时，**中介件**将信息传播给所有感兴趣的**订阅者**

主题(topic)作为中介件，将一个在域内唯一的名称与数据类型以及一组附加的特定数据 QoS(服务质量) 关联起来，实现跨域通信；即订阅者与发布者通过匹配主题发现彼此

DDS实体被建模为类或带类型的接口，后者因为能够预先分配内存而更高效

**Fast DDS-Gen**，将类型描述翻译成适当的实现，以填补接口与中间件之间的空白


外部FastDDS与ROS2配置需要相同才能通信，主要为前五点

| 项目                            | 是否必须一致       | 示例 / 说明                                          |
| ----------------------------- | ------------ | ------------------------------------------------ |
| **1. DDS Domain ID**          | ✅ 必须相同       | 默认是 `0`，可通过 `FASTDDS_DOMAIN` 环境变量或 XML/QoS 文件设置  |
| **2. Topic 名称**               | ✅ 必须相同       | 如 ROS 2 发布 `"chatter"`，Fast DDS 需使用 `"rt/chatter"`(服务请求和应答分别添加`/rq`,`/rr`前缀) |
| **3. 类型名称字符串（type name）** | ✅ 必须相同 | ROS 2 中使用`std_msgs::msg::String` ,Fast DDS 需使用`std_msgs::msg::dds_::String_`           |
| **4. 数据结构定义（IDL）**            | ✅ 必须相同       | 字段类型、顺序、结构体名、命名空间都必须一致        |
| **5. QoS 策略**                 | ✅ 强烈建议一致     | Reliability、Durability、History、Deadline 等        |
| 6. 编码格式（CDR/XCDR/XCDR2）   | ✅ 通常是 CDR    | ROS 2 默认使用 Fast DDS 的标准 CDR                      |
| 7. 安全配置（若启用 DDS-Security） | ✅ 否则握手失败     | 需共享证书、身份验证等                                      |
| 8. Discovery 配置（静态 or 动态） | ⚠️ 对某些部署重要   | 默认使用动态发现，可用 XML 设置静态匹配                           |
| 9. 网络配置（UDP/TCP、地址、端口）    | ⚠️ 跨主机部署必须配置 | 默认是 UDP + multicast                              |


直接操作 DDS 的开发者在与 ROS 2 对接时，还应了解以下更深入的规则和细节：

### 1. 服务（Services）和动作（Actions）的 Topic 命名

ROS 2 的服务和动作在 DDS 层也是通过发布/订阅 Topic 实现的。它们有自己独特的命名约定：

*   **服务 (Services)**: 一个 ROS 2 服务 `/my_service` (类型为 `my_interfaces::srv::MySrv`) 会被拆分成两个 DDS Topic：
    *   **请求 Topic**: `rq/my_serviceRequest`
    *   **应答 Topic**: `rr/my_serviceReply`
    *   **类型**: 对应的 IDL 类型通常是 `my_interfaces::srv::dds_::MySrv_Request_` 和 `my_interfaces::srv::dds_::MySrv_Response_`。

*   **动作 (Actions)**: 一个 ROS 2 动作 `/my_action` 会被拆分成多个 Topic，用于目标、结果、反馈等。例如：
    *   `/_action/send_goal`
    *   `/_action/get_result`
    *   `/_action/cancel_goal`
    *   `/_action/feedback`
    *   `/_action/status`
    *   这些 Topic 名称会与动作名称结合，例如 `rt/my_action/_action/feedback`。

### 2. QoS 策略的兼容性（非常重要）

DDS 规范定义了严格的 QoS 兼容性规则。如果发布者（Offered QoS）和订阅者（Requested QoS）的策略不兼容，它们之间**根本不会建立连接**。

*   **Reliability (可靠性)**:
    *   发布者提供 `RELIABLE`，订阅者必须请求 `RELIABLE`。
    *   发布者提供 `BEST_EFFORT`，订阅者可以请求 `BEST_EFFORT` 或 `RELIABLE` (但后者没有意义)。
*   **Durability (持久性)**:
    *   ROS 2 中 "latched" topic 通常使用 `TRANSIENT_LOCAL`。如果你的 Fast DDS 程序想接收这些历史数据，订阅者的 Durability QoS 也必须设置为 `TRANSIENT_LOCAL`。
*   **Deadline, Liveliness, Ownership**: 这些策略也都有各自的兼容性要求，不匹配会导致通信失败。

### 3. 数据类型的细微差异

*   **有界 vs. 无界 (Bounded vs. Unbounded)**: ROS 2 消息定义中经常使用有界类型，例如 `string<=255` 或 `uint8[10]`。这在 IDL 中必须精确匹配。
    *   ROS 2 `string<=255` 对应 IDL `string<256>` (IDL 的界限是不包含边界的字符数，且要为 null 终止符留一个位置)。
    *   ROS 2 `uint8[10]` (固定数组) 对应 IDL `octet[10]`。
    *   ROS 2 `uint8[]` (动态数组) 对应 IDL `sequence<octet>`。
    *   ROS 2 `uint8[<=10]` (有界动态数组) 对应 IDL `sequence<octet, 10>`。
    *   **不匹配会导致序列化/反序列化失败或直接无法连接。**

*   **嵌套类型 (Nested Types)**: 如果一个 ROS 2 消息包含了其他消息类型（如 `geometry_msgs/Pose` 包含 `Point` 和 `Quaternion`），你的主 IDL 文件需要使用 `#include` 指令来包含被嵌套类型的 IDL 定义。

### 4. ROS 2 参数事件 Topic

ROS 2 节点会自动发布一个 `/parameter_events` Topic，用于同步参数变化。如果你需要监控或与 ROS 2 的参数系统交互，就需要订阅这个 Topic (`rt/parameter_events`)，并使用其对应的 IDL (`rcl_interfaces::msg::dds_::ParameterEvent_`)。

### 5. 分区 (Partitions)

ROS 2 使用 DDS 的 Partition QoS 来实现部分命名空间（Namespace）的功能。虽然不总是使用，但在复杂的系统中，一个节点如果位于命名空间 `/ns1` 下，它发布的话题可能会被放入名为 `ns1` 的 DDS Partition 中。如果你的外部 DDS 程序没有设置正确的 Partition，将无法发现这些话题。

